<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classify Waste - Sortify AI</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <nav>
            <div class="logo">
                <a href="index.html">
                    <img src="./assests/sor.png" alt="Sortify AI Logo">
                </a>
            </div>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="learn.html">Learn</a></li>
                <li><a href="classify.html" class="active">Classify</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="contact.html">Contact</a></li>
            </ul>
        </nav>
    </header>

    <main class="classify-page">
        <section class="upload-section">
    <h2 style="color: aliceblue;">Upload your waste image</h2>
    <p>Our AI will analyze your image and tell you which bin to use for proper recycling.</p>
    
    <div class="upload-container">
        <div class="upload-box" id="dropArea">
            <div id="imagePreviewContainer" style="display: none;">
                <div class="image-controls">
                    <button class="reset-btn" id="resetBtn"><i class="fas fa-times"></i></button>
                </div>
                <img id="imagePreview" src="#" alt="Preview">
            </div>
            <div id="uploadPrompt">
                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                <p>Drag and drop or click to browse</p>
                <input type="file" id="fileInput" accept="image/*">
                <button class="upload-btn">Upload Image</button>
            </div>
        </div>
        
        <div class="categories-display">
            <div class="category">
                <img src="./assests/icon1.png" alt="Plastic">
                <span>Plastic</span>
            </div>
            <div class="category">
                <img src="./assests/icon2.png" alt="Glass">
                <span>Glass</span>
            </div>
            <div class="category">
                <img src="./assests/icon3.png" alt="Metal">
                <span>Metal</span>
            </div>
            <div class="category">
                <img src="./assests/icon4.png" alt="Cardboard">
                <span>Cardboard</span>
            </div>
            <div class="category">
                <img src="./assests/icon5.png" alt="Paper">
                <span>Paper</span>
            </div>
            <div class="category">
                <img src="./assests/icon6.png" alt="Trash">
                <span>Trash</span>
            </div>
        </div>
    </div>
    
    <div class="waiting-section" id="waitingSection">
        <h3>Analyzing image...</h3>
        <div class="loading-spinner"></div>
        <p id="loadingMessage">Connecting to AI server...</p>
    </div>
    </section>


    <section class="results-container" id="resultsSection">
            <div class="results-section">
                <h1>Classification Result</h1>
                
                <div class="result-categories" id="resultCategories">

                </div>
            </div>

            <div class="disposal-section">
            <div class="disposal-instructions">
                <div class="horizontal-layout">

                    <div class="icon-confidence">
                        <img id="categoryIcon" src="" alt="Category Icon" class="category-icon-large">
                        <div class="confidence-display">
                            <span>Confidence:</span>
                            <div class="confidence-meter">
                                <div class="progress" id="confidenceBar"></div>
                                <span class="percentage" id="confidencePercentage">0%</span>
                            </div>
                        </div>
                    </div>
                    

                    <div class="info-section">
                        <h3>About this category</h3>
                        <p id="disposalInfo">-</p>
                        
                        <h3>Disposal Tips</h3>
                        <ul class="tips-list" id="disposalTips"></ul>
                    </div>
                </div>
            </div>
        </div>
        </section>

        
        <section class="how-it-works">
            <h2 style="color: white;">How It Works</h2>
            <p>Our AI model has been trained on thousands of waste images to accurately classify items into the correct recycling categories.</p><br><br>
            <div class="steps">
                <div class="step-card">
                    <div class="step-number">1</div>
                    <h3 style="color: aliceblue;">Upload Image</h3>
                    <p>Take a clear photo of your waste item and upload it to our system.</p>
                </div>
                <div class="step-card">
                    <div class="step-number">2</div>
                    <h3 style="color: aliceblue;">AI Analysis</h3>
                    <p>Our machine learning model analyzes the image to identify the material type.</p>
                </div>
                <div class="step-card">
                    <div class="step-number">3</div>
                    <h3 style="color: aliceblue;">Get Results</h3>
                    <p>Receive accurate classification results and proper disposal instructions.</p>
                </div>
            </div>
        </section>

        <section class="did-you-know">
            <div class="did-you-know-card">
                <h2 > 
                    <i class="fas fa-lightbulb bulb-icon" style="margin-right: 10px;"></i>
                    Did you know?</h2>
                <p>Plastic bags and other plastic garbage thrown into the ocean kill as many as 1 million sea creatures every year.</p>
                <p class="source">Source: UNESCO</p>
            </div>
        </section>

        <section class="final-cta-container">
            <div class="final-cta-card">
                <h2 style="color: white;">Want to learn more about waste sorting?</h2>
                <p>Check out our comprehensive guide to waste categories and recycling best practices.</p>
                <a href="learn.html" class="cta-button">View Sorting Guide <i class="fas fa-arrow-right"></i></a>
            </div>
        </section>
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-brand">
                <img src="./assests/sor.png" alt="Sortify AI Logo" class="footer-logo">
                <p>Sortify AI helps you sort waste correctly using artificial intelligence. Our mission is to reduce landfill waste and increase recycling efficiency.</p>
            </div>
            
            <div class="footer-links-group">
                <div class="footer-links">
                    <h3 style="color: white;">Navigation</h3>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="learn.html">Learn</a></li>
                        <li><a href="classify.html">Classify</a></li>
                        <li><a href="about.html">About</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </div>
                
                <div class="footer-links">
                    <h3 style="color: white;">Legal</h3>
                    <ul>
                        <li><a href="">Privacy Policy</a></li>
                        <li><a href="">Terms of Service</a></li>
                        <li><a href="">Cookie Policy</a></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>&copy; 2025 Sortify AI. All rights reserved.</p>
        </div>
    </footer>

    <script>
        const wasteCategories = [
            { 
                id: 0,
                name: "Plastic", 
                icon: "./assests/icon1.png",
                info: "Plastic can take up to 450 years to decompose in landfill. Recycling plastic saves energy and reduces pollution.",
                tips: [
                    "Rinse plastic containers before recycling",
                    "Remove caps and lids (they're often different plastic types)",
                    "No plastic bags in curbside recycling",
                    "Check local guidelines for numbered plastics"
                ]
            },
            { 
                id: 1,
                name: "Glass", 
                icon: "./assests/icon2.png",
                info: "Glass is 100% recyclable and can be recycled endlessly without loss in quality or purity.",
                tips: [
                    "Rinse glass containers before recycling",
                    "Remove metal lids and corks",
                    "Don't mix colors if your program requires separation",
                    "No broken glass in recycling bins"
                ]
            },
            { 
                id: 2,
                name: "Metal", 
                icon: "./assests/icon3.png",
                info: "Recycling aluminum saves 95% of the energy needed to make new aluminum from raw materials.",
                tips: [
                    "Rinse metal cans before recycling",
                    "Remove paper labels if possible",
                    "Flatten cans to save space",
                    "Separate aluminum and steel if required"
                ]
            },
            { 
                id: 3,
                name: "Cardboard", 
                icon: "./assests/icon4.png",
                info: "Cardboard can be recycled 5-7 times before the fibers become too short to be reused.",
                tips: [
                    "Flatten cardboard boxes before recycling",
                    "Remove plastic packing materials",
                    "Keep cardboard dry and clean",
                    "No wax-coated cardboard (like milk cartons)"
                ]
            },
            { 
                id: 4,
                name: "Paper", 
                icon: "./assests/icon5.png",
                info: "Recycling one ton of paper saves 17 trees, 7,000 gallons of water, and 4,000 kilowatts of energy.",
                tips: [
                    "Keep paper clean and dry",
                    "Remove plastic wrapping from magazines",
                    "Shredded paper may need special handling",
                    "No paper towels, tissues, or napkins"
                ]
            },
            { 
                id: 5,
                name: "Trash", 
                icon: "./assests/icon6.png",
                info: "Items that cannot be recycled should be disposed of properly to avoid contaminating recycling streams.",
                tips: [
                    "Consider if items can be reused before trashing",
                    "Hazardous materials need special disposal",
                    "Reduce waste by choosing reusable alternatives",
                    "Compost food waste when possible"
                ]
            }
        ];

        const elements = {
            dropArea: document.getElementById('dropArea'),
            fileInput: document.getElementById('fileInput'),
            uploadBtn: document.querySelector('.upload-btn'),
            resetBtn: document.getElementById('resetBtn'),
            imagePreview: document.getElementById('imagePreview'),
            imagePreviewContainer: document.getElementById('imagePreviewContainer'),
            uploadPrompt: document.getElementById('uploadPrompt'),
            waitingSection: document.getElementById('waitingSection'),
            resultsSection: document.getElementById('resultsSection'),
            resultCategories: document.getElementById('resultCategories'),
            detectedType: document.getElementById('detectedType'),
            confidenceBar: document.getElementById('confidenceBar'),
            confidencePercentage: document.getElementById('confidencePercentage'),
            disposalInfo: document.getElementById('disposalInfo'),
            disposalTips: document.getElementById('disposalTips'),
            loadingMessage: document.getElementById('loadingMessage')
        };

        let currentImage = null;
        let currentPrediction = null;
        let isProcessing = false;

        

        document.addEventListener('DOMContentLoaded', () => {
            elements.waitingSection.style.display = 'none';
            elements.resultsSection.style.display = 'none';
        });

        elements.uploadBtn.addEventListener('click', () => elements.fileInput.click());
        elements.fileInput.addEventListener('change', handleFileChange);
        elements.resetBtn.addEventListener('click', resetUpload);

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            elements.dropArea.addEventListener(eventName, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            elements.dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            elements.dropArea.addEventListener(eventName, unhighlight, false);
        });

        elements.dropArea.addEventListener('drop', handleDrop);

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

                
        function highlight() {
            elements.dropArea.classList.add('highlight');
        }

        function unhighlight() {
            elements.dropArea.classList.remove('highlight');
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            if (file && !isProcessing) {
                handleFile(file);
            }
        }
        
        function handleFileChange() {
            if (this.files.length && !isProcessing) {
                handleFile(this.files[0]);
            }
        }

        async function handleFile(file) {
            if (!file.type.match('image.*')) {
                showError('Please upload an image file (JPEG, PNG, etc.)');
                return;
            }

            if (file.size > 88 * 1024 * 1024) { 
                showError('Image size should be less than 5MB');
                return;
            }

            resetUpload();
            isProcessing = true;

            const reader = new FileReader();
            reader.onload = function(e) {
                currentImage = e.target.result;
                elements.imagePreview.src = currentImage;
                elements.uploadPrompt.style.display = 'none';
                elements.imagePreviewContainer.style.display = 'block';
                
                analyzeImage(file);
            };
            reader.readAsDataURL(file);
        }


            async function analyzeImage(file) {
        try {
            elements.waitingSection.style.display = 'block';
            elements.resultsSection.style.display = 'none';
            
            const loadingMessages = [
                "Preparing image for analysis...",
                "Processing image features...",
                "This may take a few moments...",
                "Almost there, finishing up..."
            ];
            
            let messageIndex = 0;
            const messageInterval = setInterval(() => {
                elements.loadingMessage.textContent = loadingMessages[messageIndex];
                messageIndex = (messageIndex + 1) % loadingMessages.length;
            }, 3000);
        
            const formData = new FormData();
            formData.append('file', file);
            

            if (!navigator.onLine) {
                throw new Error('No internet connection');
            }
            
            const response = await fetch('https://sortify-15.onrender.com/classify', {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => null);
                throw new Error(errorData?.message || `Server error: ${response.status}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Invalid response format');
            }
            
            const data = await response.json();
            
            if (!data.all_predictions || !Array.isArray(data.all_predictions)) {
                throw new Error('Invalid response data structure');
            }
            
            clearInterval(messageInterval);
            
            currentPrediction = processPredictions(data.all_predictions);
            displayResults(currentPrediction);
            
            elements.waitingSection.style.display = 'none';
            elements.resultsSection.style.display = 'flex';
            elements.resultsSection.scrollIntoView({ behavior: 'smooth' });
            
        } catch (error) {
            clearInterval(messageInterval);
            console.error('Error analyzing image:', error);
            handleAnalysisError(error);
        } finally {
            isProcessing = false;
        }
    }


    function processPredictions(predictions) {
            return predictions.map((pred, index) => {
                const category = wasteCategories.find(cat => cat.id === pred.id) || wasteCategories[index];
                return {
                    ...pred,
                    info: category.info,
                    tips: category.tips,
                    icon: category.icon
                };
            }).sort((a, b) => b.confidence - a.confidence);
        }


        function displayResults(predictions) {
            if (!predictions || !Array.isArray(predictions)) {
                throw new Error('Invalid predictions data');
            }
            
            elements.resultCategories.innerHTML = '';
            
            const sortedPredictions = [...predictions].sort((a, b) => b.confidence - a.confidence);
            
            sortedPredictions.forEach((prediction, index) => {
                const categoryElement = document.createElement('div');
                categoryElement.className = `category-result ${index === 0 ? 'active result-highlight' : ''}`;
                categoryElement.innerHTML = `
                    <div class="category-icon-container">
                        <img src="${prediction.icon}" alt="${prediction.name}">
                        ${index === 0 ? `<span class="confidence-badge">${Math.round(prediction.confidence * 100)}%</span>` : ''}
                    </div>
                    <span>${prediction.name}</span>
                `;
                
                categoryElement.addEventListener('click', () => {
                    document.querySelectorAll('.category-result').forEach(el => {
                        el.classList.remove('active', 'result-highlight');
                        el.querySelector('.confidence-badge')?.remove();
                    });
                    
                    categoryElement.classList.add('active', 'result-highlight');
                    
                    if (index !== 0) {
                        const badge = document.createElement('span');
                        badge.className = 'confidence-badge';
                        badge.textContent = `${Math.round(prediction.confidence * 100)}%`;
                        categoryElement.querySelector('.category-icon-container').appendChild(badge);
                    }
                    
                    showCategoryDetails(prediction);
                });
                
                elements.resultCategories.appendChild(categoryElement);
            });
            
            showCategoryDetails(sortedPredictions[0]);
        }


        function showCategoryDetails(prediction) {
            elements.detectedType.textContent = prediction.name;
            const confidencePercent = Math.round(prediction.confidence * 100);
            elements.confidenceBar.style.width = `${confidencePercent}%`;
            elements.confidencePercentage.textContent = `${confidencePercent}%`;
            elements.disposalInfo.textContent = prediction.info || "No disposal information available.";
            

            const categoryIcon = document.getElementById('categoryIcon');
            if (categoryIcon) {
                categoryIcon.src = prediction.icon;
            }
            
            elements.disposalTips.innerHTML = '';
            if (prediction.tips && prediction.tips.length > 0) {
                prediction.tips.forEach(tip => {
                    const li = document.createElement('li');
                    li.textContent = tip;
                    elements.disposalTips.appendChild(li);
                });
            }
        }

        function handleAnalysisError(error) {
            let userMessage = "Error analyzing image. Please try again later.";
            let errorDetails = error.message || "Unknown error";
            
            if (error.message.includes('Failed to fetch') || 
                error.message.includes('NetworkError') ||
                error.message === 'No internet connection') {
                userMessage = "Network error. Please check your internet connection.";
            } else if (error.message.includes('timed out')) {
                userMessage = "Server is taking too long to respond. Please try again.";
            } else if (error.message.includes('404')) {
                userMessage = "Classification service is currently unavailable.";
            } else if (error.message.includes('413')) {
                userMessage = "Image size is too large. Please upload a smaller image (max 5MB).";
            } else if (error.message.includes('Invalid response')) {
                userMessage = "Received invalid response from server.";
            }
            
            elements.loadingMessage.textContent = userMessage;
            elements.loadingMessage.style.color = "#ff4444";
            
            setTimeout(() => {
                elements.waitingSection.style.display = 'none';
                resetUpload();
                alert(`${userMessage}\n\nDetails: ${errorDetails}`);
            }, 2000);
        }

        function showError(message) {
            alert(message);
        }

        function resetUpload() {
            elements.imagePreview.src = '#';
            elements.imagePreviewContainer.style.display = 'none';
            elements.uploadPrompt.style.display = 'block';
            currentImage = null;
            currentPrediction = null;
            elements.fileInput.value = '';
            elements.waitingSection.style.display = 'none';
            elements.resultsSection.style.display = 'none';
            isProcessing = false;
        }
    </script>
</body>
</html>
